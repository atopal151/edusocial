import 'dart:io';

import 'package:edusocial/controllers/post_controller.dart';
import 'package:edusocial/controllers/profile_controller.dart';
import 'package:edusocial/models/language_model.dart';
import 'package:edusocial/models/profile_model.dart';
import 'package:edusocial/services/onboarding_service.dart';
import 'package:edusocial/services/profile_service.dart';
import 'package:edusocial/services/profile_update_services.dart';
import 'package:edusocial/services/language_service.dart';
import 'package:edusocial/services/lesson_service.dart';
import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:image_picker/image_picker.dart';
import 'package:intl/intl.dart';

import '../../components/snackbars/custom_snackbar.dart';

class ProfileUpdateController extends GetxController {
  final _profileService = ProfileService();
  final _languageService = Get.find<LanguageService>();

  // Ana model (backend'den gelen t√ºm veriler burada tutulur)
  Rx<ProfileModel?> userProfileModel = Rx<ProfileModel?>(null);

  RxList<Map<String, dynamic>> userSchools = <Map<String, dynamic>>[].obs;
  RxList<Map<String, dynamic>> userDepartments = <Map<String, dynamic>>[].obs;
  final TextEditingController lessonController = TextEditingController();

  /// üåç Diller
  var languages = <LanguageModel>[].obs;
  var selectedLanguageId = Rxn<int>();
  var selectedLanguageCode = ''.obs; // Dil kodu (tr, en)

  var selectedSchoolName = "".obs;
  int? selectedSchoolId;

  var selectedDepartmentName = "".obs;
  int? selectedDepartmentId;

  // Y√ºklenme durumu
  var isLoading = false.obs;

  // Se√ßilen avatar dosyasƒ±
  File? selectedAvatar;
  File? selectedCoverPhoto; // Yeni alan
  // Form controller'larƒ±
  final usernameController = TextEditingController();
  final nameController = TextEditingController();
  final surnameController = TextEditingController();
  final emailController = TextEditingController();
  final phoneController = TextEditingController();
  final birthdayController = TextEditingController();
  final instagramController = TextEditingController();
  final twitterController = TextEditingController();
  final facebookController = TextEditingController();
  final linkedinController = TextEditingController();
  final schoolIdController = TextEditingController();
  final departmentIdController = TextEditingController();
  final descriptionController = TextEditingController();
  final tiktokController = TextEditingController();
  final languageIdController = TextEditingController();

  // Ekstra se√ßenekler
  var accountType = ''.obs; // "private" veya "public"
  var emailNotification = true.obs;
  var mobileNotification = true.obs;
  var selectedLessons = <String>[].obs;

  @override
  void onInit() {
    super.onInit();
    fetchUserProfile();
    fetchLanguages();
  }

  /// üåç Dilleri API'den √ßek
  Future<void> fetchLanguages() async {
    try {
      languages.value = await ProfileUpdateService.fetchLanguages();
      
      // Mevcut dili se√ß
      _setCurrentLanguage();
    } catch (e) {
      Get.snackbar('Hata', 'Dilleri √ßekerken hata olu≈ütu!');
    }
  }

  /// Mevcut dili se√ß
  void _setCurrentLanguage() {
    // √ñnce profil verisinden dil kodunu al
    final profileLanguage = userProfileModel.value?.language;
    
    if (profileLanguage != null && profileLanguage.isNotEmpty) {
      // Profilde dil varsa, o dili se√ß
      final languageModel = languages.firstWhereOrNull(
        (lang) => lang.code == profileLanguage,
      );
      
      if (languageModel != null) {
        selectedLanguageId.value = languageModel.id;
        selectedLanguageCode.value = languageModel.code;
      } else {
        // Profildeki dil desteklenmiyorsa varsayƒ±lan dili se√ß
        _setDefaultLanguage();
      }
    } else {
      // Profilde dil yoksa varsayƒ±lan dili se√ß
      _setDefaultLanguage();
    }
  }

  /// Varsayƒ±lan dili se√ß (ƒ∞ngilizce)
  void _setDefaultLanguage() {
    final defaultLanguage = languages.firstWhereOrNull(
      (lang) => lang.code == 'en',
    );
    
    if (defaultLanguage != null) {
      selectedLanguageId.value = defaultLanguage.id;
      selectedLanguageCode.value = defaultLanguage.code;
    }
  }

  /// Dil se√ßildiƒüinde √ßaƒürƒ±lƒ±r
  void onLanguageSelected(int languageId) {
    final selectedLanguage = languages.firstWhereOrNull(
      (lang) => lang.id == languageId,
    );
    
    if (selectedLanguage != null) {
      selectedLanguageId.value = languageId;
      selectedLanguageCode.value = selectedLanguage.code;
      
      // Dil servisini g√ºncelle
      _languageService.changeLanguage(selectedLanguage.code);
      
      debugPrint('Dil deƒüi≈ütirildi: ${selectedLanguage.code}');
    }
  }

  Future<void> loadUserSchoolList() async {
    isLoading.value = true;
    try {
      final data = await OnboardingServices.fetchSchools();
      userSchools.assignAll(data);

      if (userSchools.isNotEmpty) {
        // Eƒüer profilden gelen ID varsa, okul adƒ± e≈üle≈ümesi yap
        final selectedSchool = userSchools.firstWhereOrNull(
          (school) => school['id'].toString() == schoolIdController.text,
        );
        if (selectedSchool != null) {
          selectedSchoolName.value = selectedSchool['name'];
          selectedSchoolId = selectedSchool['id'];
          loadDepartmentsForSelectedSchool();
        }
      }
    } catch (e) {
      debugPrint("‚ùó Kullanƒ±cƒ± okul listesi y√ºklenirken hata: $e",
          wrapWidth: 1024);
    } finally {
      isLoading.value = false;
    }
  }

  void loadDepartmentsForSelectedSchool() {
    final selected = userSchools.firstWhereOrNull(
      (school) => school['id'] == selectedSchoolId,
    );
    if (selected != null && selected['departments'] != null) {
      userDepartments.assignAll(
        (selected['departments'] as List)
            .map<Map<String, dynamic>>((d) => {
                  "id": d['id'],
                  "title": d['title'],
                })
            .toList(),
      );

      if (userDepartments.isNotEmpty) {
        final selectedDept = userDepartments.firstWhereOrNull(
          (dept) => dept['id'].toString() == departmentIdController.text,
        );
        if (selectedDept != null) {
          selectedDepartmentName.value = selectedDept['title'];
          selectedDepartmentId = selectedDept['id'];
        }
      }
    }
  }

  void onSchoolChanged(String schoolName) {
    final selected =
        userSchools.firstWhereOrNull((school) => school['name'] == schoolName);

    if (selected != null) {
      selectedSchoolName.value = selected['name'];
      selectedSchoolId = selected['id'];
      loadDepartmentsForSelectedSchool();
    }
  }

  void onDepartmentChanged(String departmentName) {
    final selected = userDepartments.firstWhereOrNull(
      (dept) => dept['title'] == departmentName,
    );
    if (selected != null) {
      selectedDepartmentName.value = selected['title'];
      selectedDepartmentId = selected['id'];
    }
  }

  String formatBirthday(String isoString) {
    try {
      DateTime parsed = DateTime.parse(isoString);
      return DateFormat('dd.MM.yyyy').format(parsed);
    } catch (e) {
      return '';
    }
  }

  /// üì∏ Galeriden resim se√ßme
  Future<void> pickImageFromGallery() async {
    final pickedProfileFile =
        await ImagePicker().pickImage(source: ImageSource.gallery);
    if (pickedProfileFile != null) {
      selectedAvatar = File(pickedProfileFile.path);
    }
  }

  Future<void> pickCoverPhotoFromGallery() async {
    final pickedFile =
        await ImagePicker().pickImage(source: ImageSource.gallery);
    if (pickedFile != null) {
      selectedCoverPhoto = File(pickedFile.path);
    }
  }

  /// üîÑ Profil verisini API'den √ßek
  Future<void> fetchUserProfile() async {
    isLoading.value = true;
    try {
      final profileData = await _profileService.fetchProfileData();
      userProfileModel.value = profileData;
      loadUserData(); // TextField'lara aktar
      await loadUserSchoolList();
    } catch (e) {
      Get.snackbar("Hata", "Profil verisi alƒ±namadƒ±: $e");
    } finally {
      isLoading.value = false;
    }
  }

  /// üß† Gelen verileri formlara yerle≈ütir
  void loadUserData() {
    final data = userProfileModel.value;
    if (data == null) return;

    //adebugPrint("üì• Profil form verileri y√ºkleniyor...", wrapWidth: 1024);

    usernameController.text = data.username;
    nameController.text = data.name;
    surnameController.text = data.surname;
    emailController.text = data.email;
    birthdayController.text = formatBirthday(data.birthDate);
    phoneController.text = data.phone ?? ''; // null olabilir
    instagramController.text = data.instagram ?? '';
    twitterController.text = data.twitter ?? '';
    facebookController.text = data.facebook ?? '';
    linkedinController.text = data.linkedin ?? '';
    schoolIdController.text = data.schoolId ?? '';
    departmentIdController.text = data.schoolDepartmentId ?? '';
    accountType.value = data.accountType;
    emailNotification.value = data.notificationEmail;
    mobileNotification.value = data.notificationMobile;
    selectedLessons.value = data.lessons;
    
    debugPrint("üìö Profil verilerinden dersler y√ºklendi: ${data.lessons}");
    descriptionController.text = data.description ?? '';
    tiktokController.text = data.tiktok ?? '';
    languageIdController.text = data.languageId ?? '';

    // üåç Se√ßili dil id'sini de set et
    if (data.languageId != null && data.languageId!.isNotEmpty) {
      selectedLanguageId.value = int.tryParse(data.languageId!);
      
      // Dil kodunu da set et
      final languageModel = languages.firstWhereOrNull(
        (lang) => lang.id == selectedLanguageId.value,
      );
      if (languageModel != null) {
        selectedLanguageCode.value = languageModel.code;
        
        // Dil servisini g√ºncelle
        _languageService.setLanguageFromProfile(languageModel.code);
      }
    }
  }

  /// üéõÔ∏è Switch kontroller
  void toggleEmailNotification(bool value) {
    emailNotification.value = value;
  }

  void toggleMobileNotification(bool value) {
    mobileNotification.value = value;
  }

  void changeAccountType(String type) {
    accountType.value = type;
  }

  /// üìö Ders i≈ülemleri
  
  /// Dersi sadece UI'dan kaldƒ±r (backend'den silme)
  void removeLessonFromUI(String lesson) {
    debugPrint("üîÑ ProfileUpdateController: Ders UI'dan kaldƒ±rƒ±lƒ±yor...");
    debugPrint("üìö Kaldƒ±rƒ±lacak ders: $lesson");
    debugPrint("üìä Mevcut ders listesi: ${selectedLessons.toList()}");
    
    if (selectedLessons.contains(lesson)) {
      selectedLessons.remove(lesson);
      debugPrint("‚úÖ Ders UI'dan kaldƒ±rƒ±ldƒ±: $lesson");
      debugPrint("üìä G√ºncel ders listesi: ${selectedLessons.toList()}");
      
      CustomSnackbar.show(
        title: _languageService.tr("common.success"),
        message: "'$lesson' dersi listeden kaldƒ±rƒ±ldƒ±",
        type: SnackbarType.success,
      );
    } else {
      debugPrint("‚ùå Ders listede bulunamadƒ±: $lesson");
    }
  }
  
  Future<void> addLesson(String lesson) async {
    debugPrint("üîÑ ProfileUpdateController: Ders ekleme i≈ülemi ba≈ülatƒ±lƒ±yor...");
    debugPrint("üìö Ders adƒ±: ${lesson.trim()}");
    
    if (lesson.trim().isEmpty) {
      debugPrint("‚ùå Validation hatasƒ±: Ders adƒ± bo≈ü");
      CustomSnackbar.show(
        title: _languageService.tr("common.warning"),
        message: _languageService.tr("profile.editProfile.lessonNameEmpty"),
        type: SnackbarType.warning,
      );
      return;
    }

    if (selectedLessons.contains(lesson.trim())) {
      debugPrint("‚ùå Validation hatasƒ±: Ders zaten mevcut");
      CustomSnackbar.show(
        title: _languageService.tr("common.warning"),
        message: _languageService.tr("profile.editProfile.lessonAlreadyExists"),
        type: SnackbarType.warning,
      );
      return;
    }

    debugPrint("‚úÖ Validation ba≈üarƒ±lƒ±, API √ßaƒürƒ±sƒ± yapƒ±lƒ±yor...");
    
    try {
      debugPrint("üì§ LessonService.addLessonWithId() √ßaƒürƒ±lƒ±yor...");
      final result = await LessonService.addLessonWithId(lesson.trim());
      
      debugPrint("üì• LessonService'den d√∂nen sonu√ß: $result");
      
      if (result['success'] as bool) {
        debugPrint("‚úÖ Ders ba≈üarƒ±yla eklendi: ${lesson.trim()}");
        
        debugPrint("üìù selectedLessons listesine ekleniyor...");
        selectedLessons.add(lesson.trim());
        debugPrint("üìä G√ºncel ders listesi: ${selectedLessons.toList()}");
        
        CustomSnackbar.show(
          title: _languageService.tr("common.success"),
          message: _languageService.tr("profile.editProfile.lessonAdded"),
          type: SnackbarType.success,
        );
        
        debugPrint("üîÑ Profil verileri yenileniyor...");
        await fetchUserProfile();
        debugPrint("‚úÖ Profil verileri yenilendi");
      } else {
        debugPrint("‚ùå Ders eklenemedi: ${lesson.trim()}");
        debugPrint("‚ùå API'den ba≈üarƒ±sƒ±z sonu√ß d√∂nd√º");
        CustomSnackbar.show(
          title: _languageService.tr("common.error"),
          message: _languageService.tr("profile.editProfile.lessonAddError"),
          type: SnackbarType.error,
        );
      }
    } catch (e, stackTrace) {
      debugPrint("üí• Ders ekleme hatasƒ±: $e");
      debugPrint("üí• Stack trace: $stackTrace");
      CustomSnackbar.show(
        title: _languageService.tr("common.error"),
        message: _languageService.tr("profile.editProfile.lessonAddError"),
        type: SnackbarType.error,
      );
    }
    
    debugPrint("üèÅ Ders ekleme i≈ülemi tamamlandƒ±");
  }



  /// ‚¨ÖÔ∏è Geri d√∂n
  void goBack() {
    Get.back();
  }

  /// üíæ Kaydetme i≈ülemi
  Future<void> saveProfile() async {
    isLoading.value = true;

    if (usernameController.text.isEmpty || emailController.text.isEmpty) {
      Get.snackbar("Hata", "Kullanƒ±cƒ± adƒ± ve e-posta bo≈ü olamaz.");
      isLoading.value = false;
      return;
    }

    try {
      await ProfileUpdateService.updateProfile(
        username: usernameController.text,
        name: nameController.text,
        surname: surnameController.text,
        email: emailController.text,
        phone: phoneController.text,
        birthday: birthdayController.text,
        instagram: instagramController.text,
        twitter: twitterController.text,
        facebook: facebookController.text,
        linkedin: linkedinController.text,
        accountType: accountType.value,
        emailNotification: emailNotification.value,
        mobileNotification: mobileNotification.value,
        schoolId: selectedSchoolId?.toString() ?? '',
        departmentId: selectedDepartmentId?.toString() ?? '',
        lessons: selectedLessons.toList(),
        avatarFile: selectedAvatar,
        coverFile: selectedCoverPhoto,
        description: descriptionController.text,
        tiktok: tiktokController.text,
        languageId: selectedLanguageId.value?.toString() ?? '',
      );

      // Ba≈üarƒ±lƒ± snackbar'ƒ± kaldƒ±rƒ±ldƒ±.
      // Ana profil sayfasƒ±ndaki verileri g√ºncelle.
      await Get.find<ProfileController>().loadProfile();
      // Post verilerini de g√ºncelle
      await Get.find<PostController>().fetchHomePosts();
      Get.back(); // Bir √∂nceki sayfaya d√∂n.
    } catch (e) {
      CustomSnackbar.show(
          title: "Hata",
          message: "Profil g√ºncellenemedi: $e",
          type: SnackbarType.error);
    } finally {
      isLoading.value = false;
    }
  }
}
